<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>IPC Calc Tools - HHSAF Analysis</title>
    <meta name="description" content="WHO HHSAF Analysis Tool running entirely in the browser using stlite.">
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.53.0/build/stlite.js"></script>
    <style>
        /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼šæ—¥æœ¬èªã‚’è¦‹ã‚„ã™ã */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script>
        stlite.mount({
            requirements: ["pandas", "plotly", "streamlit"],
            entrypoint: "app.py",
            streamlitConfig: {
                "server.maxUploadSize": 500,
                "client.toolbarMode": "viewer"
            },
            files: {
                "app.py": `
import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
import io
import re

# --- 1. Language & Configurations ---
st.set_page_config(layout="wide", page_title="IPC Calc Tools", page_icon="ğŸ¥")

# Hide anchor links
st.markdown("""
    <style>
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
    .st-emotion-cache-1629p8f a, .st-emotion-cache-10trblm a, .st-emotion-cache-1r7r3e4 a {
        display: none !important;
    }
    /* ä¸€èˆ¬çš„ãªã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯ã®éè¡¨ç¤ºè¨­å®š */
    h1 a, h2 a, h3 a, h4 a, h5 a, h6 a {
        display: none !important;
    }
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼å«ã‚€ï¼‰ã‚’éè¡¨ç¤º */
    [data-testid="stHeader"] {
        display: none;
    }
    </style>
""", unsafe_allow_html=True)

# Translations / ç¿»è¨³è¾æ›¸
TRANS = {
    "ja": {
        "title": "HHSAF ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«",
        "subtitle": "WHO æ‰‹æŒ‡è¡›ç”Ÿè‡ªå·±è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ (HHSAF) åˆ†æã‚·ã‚¹ãƒ†ãƒ ",
        "upload_label": "CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
        "upload_help": "Shift-JIS ã¾ãŸã¯ UTF-8 å½¢å¼ã®CSVã«å¯¾å¿œã—ã¦ã„ã¾ã™",
        "select_facility": "æ–½è¨­ã‚’é¸æŠ",
        "select_month": "ç™»éŒ²å¹´æœˆã‚’é¸æŠ",
        "total_score": "ç·åˆã‚¹ã‚³ã‚¢",
        "leadership_score": "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—åŸºæº–ã‚¹ã‚³ã‚¢",
        "leadership_status": "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—åˆ¤å®š",
        "eligible": "è©•ä¾¡å¯¾è±¡ (376ç‚¹ä»¥ä¸Š)",
        "not_eligible": "è©•ä¾¡å¯¾è±¡å¤– (ç·åˆã‚¹ã‚³ã‚¢ä¸è¶³)",
        "radar_title": "5ã¤ã®ã‚³ã‚¢é ˜åŸŸ (Core Areas)",
        "bar_chart_title": "ã‚¨ãƒªã‚¢åˆ¥ã‚¹ã‚³ã‚¢æ¯”è¼ƒ",
        "progress_bar_title": "ã‚¨ãƒªã‚¢åˆ¥é”æˆç‡",
        "question_detail_title": "è©³ç´°è³ªå•ã‚¹ã‚³ã‚¢ï¼ˆå„ã‚¨ãƒªã‚¢100ç‚¹æº€ç‚¹ä¸­ï¼‰",
        "question_label": "è³ªå•é …ç›®",
        "score_label": "ã‚¹ã‚³ã‚¢",
        "area_total": "ã‚¨ãƒªã‚¢åˆè¨ˆ",
        "area_labels": ["ã‚·ã‚¹ãƒ†ãƒ å¤‰é©", "æ•™è‚²ãƒ»ç ”ä¿®", "è©•ä¾¡ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯", "è·å ´ã§ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼", "çµ„ç¹”ã®å®‰å…¨é¢¨åœŸ"],
        "area_labels_full": ["System Change", "Training and Education", "Evaluation and Feedback", "Reminders in the Workplace", "Institutional Safety Climate"],
        "tab_dashboard": "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰",
        "tab_timeseries": "çµŒæ™‚çš„å¤‰åŒ–",
        "tab_comparison": "æ–½è¨­é–“æ¯”è¼ƒ",
        "tab_leadership": "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—åŸºæº–",
        "err_encoding": "ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚CSVã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
        "level_labels": ["ä¸ååˆ† (Inadequate)", "åŸºæœ¬ (Basic)", "ä¸­ç´š (Intermediate)", "ä¸Šç´š (Advanced)"],
        "level_short": ["ä¸ååˆ†", "åŸºæœ¬", "ä¸­ç´š", "ä¸Šç´š"],
        "points": "ç‚¹",
        "download_chart": "ãƒãƒ£ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        "no_data": "ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“",
        "landing_info": "ğŸ‘ˆ å·¦å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚",
        "landing_title": "ğŸ“Š IPC Calc Tools ã«ã¤ã„ã¦",
        "landing_features": "âœ¨ ç‰¹å¾´",
        "landing_security": "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œãšã€ã™ã¹ã¦ã‚ãªãŸã®PCå†…ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒï¼‰ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚",
        "landing_simple": "ç°¡å˜: CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã ã‘ã§ã€ã‚°ãƒ©ãƒ•ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚",
        "landing_features_desc": "å¤šæ©Ÿèƒ½: ç·åˆã‚¹ã‚³ã‚¢ã ã‘ã§ãªãã€çµŒæ™‚å¤‰åŒ–ã‚„ä»–æ–½è¨­æ¯”è¼ƒã‚‚ã‚¿ãƒ–ã§åˆ‡ã‚Šæ›¿ãˆã¦ç¢ºèªã§ãã¾ã™ã€‚",
        "landing_format": "ğŸ“ å¯¾å¿œCSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ",
        "landing_format_desc": "J-SIPHEç­‰ã‹ã‚‰å‡ºåŠ›ã•ã‚Œã‚‹å½¢å¼ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®åˆ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š",
        "comparison_title": "æ–½è¨­é–“æ¯”è¼ƒ",
        "time_series_title": "çµŒæ™‚çš„å¤‰åŒ–",
        "leadership_chart_title": "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—åŸºæº–ã‚¹ã‚³ã‚¢",
        "no_leadership_data": "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—åŸºæº–ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“",
        "leadership_required_score": "ç·åˆã‚¹ã‚³ã‚¢ãŒ{score}ç‚¹ã®ãŸã‚ã€ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—åŸºæº–ã®è©•ä¾¡ã«ã¯376ç‚¹ä»¥ä¸ŠãŒå¿…è¦ã§ã™ã€‚",
        "back_to_top": "ğŸ  TOPç”»é¢ã«æˆ»ã‚‹/åˆæœŸåŒ–ã™ã‚‹",
        "back_to_top_help": "âš ï¸ TOPç”»é¢ã«æˆ»ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ã¯åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚",
        "memory_warning": "âš ï¸ æ³¨æ„: æ•°ç™¾MBã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€éš›ã¯ã€PCã®ãƒ¡ãƒ¢ãƒªã‚’å¤§é‡ã«æ¶ˆè²»ã—ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãŸã‚Šã€å‹•ä½œãŒåœæ­¢ã—ãŸã‚Šã™ã‚‹å ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹ã‹ã€è¡Œæ•°ã‚’æ¸›ã‚‰ã—ã¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
        "landing_desc": "WHOãŒæ¨å¥¨ã™ã‚‹**æ‰‹æŒ‡è¡›ç”Ÿè‡ªå·±è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ (HHSAF)** ã®çµæœã‚’ã€ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã§ã™ãã«å¯è¦–åŒ–ãƒ»åˆ†æã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚",
        "settings": "âš™ï¸ è¨­å®š",
        "language": "è¨€èª",
        "chart_theme": "ã‚°ãƒ©ãƒ•ã®é…è‰²",
        "theme_light": "ãƒ©ã‚¤ãƒˆ (Light)",
        "theme_dark": "ãƒ€ãƒ¼ã‚¯ (Dark)",
        "theme_note": "â€»èƒŒæ™¯ã®ãƒ†ãƒ¼ãƒï¼ˆã‚¢ãƒ—ãƒªå…¨ä½“ã®è‰²ï¼‰ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šï¼ˆãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰ã‹ã‚‰å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚",
        "analysis_unit": "åˆ†æå˜ä½",
        "unit_month": "æœˆæ¬¡ (Monthly)",
        "unit_year": "å¹´æ¬¡ (Yearly)",
        "agg_method": "é›†è¨ˆæ–¹æ³• (åŒä¸€å¹´å†…ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†)",
        "agg_end": "å¹´ã®æœ€å¾Œ (End of Year) [ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ]",
        "agg_start": "å¹´ã®åˆã‚ (Start of Year)",
        "agg_mean": "å¹´ã®å¹³å‡ (Average)",
        "select_year": "å¯¾è±¡å¹´ã‚’é¸æŠ",
        "leadership_achieved": "ğŸ‰ æ‰‹æŒ‡è¡›ç”Ÿãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ãƒ¬ãƒ™ãƒ«åˆ°é”ï¼",
        "leadership_failed": "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ãƒ¬ãƒ™ãƒ«æœªé”",
        "leadership_criteria_desc": "æ¡ä»¶: å„åŒºåˆ†ã§å°‘ãªãã¨ã‚‚1ã¤ã®åŸºæº–ã‚’æº€ãŸã—ã€ã‹ã¤åˆè¨ˆã‚¹ã‚³ã‚¢ãŒ12ç‚¹ä»¥ä¸Š",
        "congrats": "ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ç´ æ™´ã‚‰ã—ã„å–ã‚Šçµ„ã¿ã§ã™ã€‚ã‚ãªãŸã®æ–½è¨­ã¯æ‰‹æŒ‡è¡›ç”Ÿãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«é”æˆã—ã¦ã„ã¾ã™ã€‚",
        "leadership_criteria_full": "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ãƒ¬ãƒ™ãƒ«é”æˆè¦ä»¶: ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—åŸºæº–ã®5ã¤ã®åŒºåˆ†ã®ãã‚Œãã‚Œã«ãŠã„ã¦å°‘ãªãã¨ã‚‚1ã¤ã‚’æº€ãŸã—ï¼ˆã€Œã¯ã„ã€ã¨å›ç­”ï¼‰ã€ã‹ã¤ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—åŸºæº–ã‚¹ã‚³ã‚¢ã®åˆè¨ˆãŒ12ç‚¹ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ã€‚",
        "err_file_size_exceeded": "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒåˆ¶é™ã‚’è¶…ãˆã¦ã„ã¾ã™",
        "err_file_size_detail": "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºãŒ500MBã‚’è¶…ãˆã¦ã„ã¾ã™ï¼ˆåˆè¨ˆ: {total_mb:.2f}MB / åˆ¶é™: 500MBï¼‰ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã™ã‚‹ã‹ã€ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
        "github_link": "ğŸ“¦ GitHubãƒªãƒã‚¸ãƒˆãƒª",
        "github_desc": "ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å…¬é–‹ã—ã¦ã„ã¾ã™",
        "github_open": "ğŸ”— GitHubã§é–‹ã"
    },
    "en": {
        "title": "HHSAF Data Visualization Tool",
        "subtitle": "WHO Hand Hygiene Self-Assessment Framework Analysis System",
        "upload_label": "Upload CSV File",
        "upload_help": "Supports Shift-JIS or UTF-8 CSV",
        "select_facility": "Select Facility",
        "select_month": "Select Month",
        "total_score": "Total Score",
        "leadership_score": "Leadership Score",
        "leadership_status": "Leadership Status",
        "eligible": "Eligible (Total >= 376)",
        "not_eligible": "Not Eligible (Insufficient Total Score)",
        "radar_title": "5 Core Areas",
        "bar_chart_title": "Area Score Comparison",
        "progress_bar_title": "Area Achievement Rate",
        "question_detail_title": "Detailed Question Scores",
        "question_label": "Question",
        "score_label": "Score",
        "area_total": "Area Total",
        "area_labels": ["System Change", "Training & Education", "Evaluation & Feedback", "Reminders", "Safety Climate"],
        "area_labels_full": ["System Change", "Training and Education", "Evaluation and Feedback", "Reminders in the Workplace", "Institutional Safety Climate"],
        "tab_dashboard": "Dashboard",
        "tab_timeseries": "Time Series",
        "tab_comparison": "Comparison",
        "tab_leadership": "Leadership Criteria",
        "err_encoding": "Failed to read file. Please check CSV format.",
        "level_labels": ["Inadequate", "Basic", "Intermediate", "Advanced"],
        "level_short": ["Inadequate", "Basic", "Intermediate", "Advanced"],
        "points": "points",
        "download_chart": "Download Chart",
        "no_data": "No data available",
        "landing_info": "ğŸ‘ˆ Please upload a CSV file from the sidebar.",
        "landing_title": "ğŸ“Š About IPC Calc Tools",
        "landing_features": "âœ¨ Features",
        "landing_security": "Security: Data is processed entirely on your PC and never sent to external servers.",
        "landing_simple": "Simple: Just drag and drop a CSV file to automatically generate beautiful charts.",
        "landing_features_desc": "Multi-functional: View total scores, temporal changes, and facility comparisons in separate tabs.",
        "landing_format": "ğŸ“ Supported CSV Format",
        "landing_format_desc": "Compatible with formats exported from J-SIPHE. The following columns are required:",
        "comparison_title": "Facility Comparison",
        "time_series_title": "Temporal Changes",
        "leadership_chart_title": "Leadership Criteria Score",
        "no_leadership_data": "No leadership criteria data available",
        "leadership_required_score": "Total score is {score} points. Leadership criteria evaluation requires 376 points or more.",
        "back_to_top": "ğŸ  Back to TOP / Reset",
        "back_to_top_help": "âš ï¸ Returning to TOP will reset all data.",
        "memory_warning": "âš ï¸ Warning: Loading large files (hundreds of MB) consumes significant memory. If the browser crashes or freezes, please try splitting the file or reducing the number of rows.",
        "landing_desc": "A tool to visualize and analyze **WHO Hand Hygiene Self-Assessment Framework (HHSAF)** results instantly in your browser.",
        "settings": "âš™ï¸ Settings",
        "language": "Language",
        "chart_theme": "Chart Theme",
        "theme_light": "Light",
        "theme_dark": "Dark",
        "theme_note": "*Note: To change the background theme (app appearance), please use your browser's Light/Dark mode settings.",
        "analysis_unit": "Analysis Unit",
        "unit_month": "Monthly",
        "unit_year": "Yearly",
        "agg_method": "Aggregation Method",
        "agg_end": "End of Year [Default]",
        "agg_start": "Start of Year",
        "agg_mean": "Average",
        "select_year": "Select Year",
        "leadership_achieved": "ğŸ‰ Hand Hygiene Leadership Level Reached!",
        "leadership_failed": "Leadership Level Not Reached",
        "leadership_criteria_desc": "Criteria: At least one criteria met per category AND total score >= 12",
        "congrats": "Congratulations and thank you! Your facility has reached the Hand Hygiene Leadership level.",
        "leadership_criteria_full": "Leadership Level Criteria: At least one leadership criteria must be met ('yes') in each of the 5 categories AND the total leadership score must be 12 or more.",
        "err_file_size_exceeded": "âŒ Error: File size limit exceeded",
        "err_file_size_detail": "The total size of uploaded files exceeds 500MB (Total: {total_mb:.2f}MB / Limit: 500MB). Please split the files or reduce their size and try again.",
        "github_link": "ğŸ“¦ GitHub Repository",
        "github_desc": "Source code and sample data are available",
        "github_open": "ğŸ”— Open on GitHub"
    }
}

# Leadership Criteria Descriptions / ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—åŸºæº–ã®è©³ç´°
LEADERSHIP_DESC = {
    "1.1": {
        "ja": "Point-of-care ã§ã®æ‰‹æŒ‡è¡›ç”Ÿã‚’è‡³é©åŒ–ã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ¼ã®å¤‰æ›´ã«é–¢ã™ã‚‹è²»ç”¨ä¾¿ç›Šåˆ†æãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Has a cost-benefit analysis of infrastructure changes required for the performance of optimal hand hygiene at the point of care been performed?"
    },
    "1.2": {
        "ja": "è‡ªæ–½è¨­ã§å®Ÿæ–½ã•ã‚Œã‚‹æ‰‹æŒ‡è¡›ç”Ÿã® 80% ä»¥ä¸Šã‚’æ‰‹æŒ‡æ¶ˆæ¯’ãŒå ã‚ã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Does alcohol-based handrubbing account for at least 80% of hand hygiene actions performed in your facility."
    },
    "2.1": {
        "ja": "æ‰‹æŒ‡è¡›ç”Ÿãƒãƒ¼ãƒ ã¯ã€åœ°åŸŸã®ä»–ã®æ–½è¨­ã®ä»£è¡¨è€…ã«å¯¾ã—ã€æ‰‹æŒ‡è¡›ç”Ÿæ¨é€²ã®ãŸã‚ã®ç ”ä¿®ã‚’è¡Œã£ã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Has the hand hygiene team undertaken training of representatives from other facilities in the area of hand hygiene promotion?"
    },
    "2.2": {
        "ja": "åœ°åŸŸã®åŒ»å¸«ãŠã‚ˆã³çœ‹è­·å¸«ã®æ•™è‚²ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã«æ‰‹æŒ‡è¡›ç”Ÿã®åŸå‰‡ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Have hand hygiene principles been incorporated into local medical and nursing educational curricula?"
    },
    "3.1": {
        "ja": "ç‰¹å®šã®åŒ»ç™‚é–¢é€£æ„ŸæŸ“ï¼ˆHCAIï¼‰ã¯ç›£è¦–ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼ˆStaphylococcus aureus èŒè¡€ç—‡ã€ã‚°ãƒ©ãƒ é™°æ€§èŒèŒè¡€ç—‡ã€åŒ»ç™‚å™¨å…·é–¢é€£æ„ŸæŸ“ç—‡ç­‰ï¼‰ã€‚",
        "en": "Are specific healthcare associated infections (HCAIs) monitored? (eg. Staphylococcus aureus bacteremia, Gram negative bacteremia, device-related infections)"
    },
    "3.2": {
        "ja": "ãƒã‚¤ãƒªã‚¹ã‚¯éƒ¨é–€ï¼ˆé›†ä¸­æ²»ç™‚å®¤ã€æ–°ç”Ÿå…å®¤ç­‰ï¼‰ã«ãŠã„ã¦ HCAI ã‚’ç›£è¦–ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã™ã‹ã€‚",
        "en": "Is a system in place for monitoring of HCAI in high risk-settings? (e.g. intensive care and neonatal units)"
    },
    "3.3": {
        "ja": "ï¼ˆæœ€ä½ã§ã‚‚ï¼‰å¹´ 1 å›ã¯æ–½è¨­å…¨ä½“ã® HCAI æœ‰ç—…ç‡èª¿æŸ»ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Is a facility-wide prevalence survey of HCAI performed (at least) annually?"
    },
    "3.4": {
        "ja": "æ‰‹æŒ‡è¡›ç”Ÿéµå®ˆç‡ã¨åˆã‚ã›ã¦ã€HCAI ç‡ã‚’æ–½è¨­ã®ç®¡ç†è· / å¹¹éƒ¨ãŠã‚ˆã³åŒ»ç™‚å¾“äº‹è€…ã«å ±å‘Šã—ã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Are HCAI rates presented to facility leadership and to health-care workers in conjunction with hand hygiene compliance rates?"
    },
    "3.5": {
        "ja": "æ–½è¨­ã«ãŠã„ã¦ã€æ‰‹æŒ‡è¡›ç”Ÿéµå®ˆç‡ã®æ”¹å–„ã«å¯¾ã™ã‚‹éšœå®³ã‚„ HCAI ã®åŸå› ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®ä½“ç³»çš„ãªè©•ä¾¡ãŒè¡Œã‚ã‚Œã€ã¾ãŸã€è©•ä¾¡çµæœã¯ç®¡ç†è· / å¹¹éƒ¨ã«å ±å‘Šã•ã‚Œã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Is structured evaluation undertaken to understand the obstacles to optimal hand hygiene compliance and the causes of HCAI at the local level, and results reported to the facility leadership?"
    },
    "4.1": {
        "ja": "æ–½è¨­ã®åŒ»ç™‚å¾“äº‹è€…ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«ã‚ˆã‚‹æ–°ã—ã„ãƒã‚¹ã‚¿ãƒ¼ã‚’ä½œã‚‹ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ã‚Šã¾ã™ã‹ã€‚",
        "en": "Is a system in place for creation of new posters designed by local health-care workers?"
    },
    "4.2": {
        "ja": "è‡ªæ–½è¨­ãŒä½œã£ãŸãƒã‚¹ã‚¿ãƒ¼ãŒä»–æ–½è¨­ã§ã‚‚ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Are posters created in your facility used in other facilities?"
    },
    "4.3": {
        "ja": "è‡ªæ–½è¨­ã«ãŠã„ã¦ã€æ‰‹æŒ‡è¡›ç”Ÿã‚’å–šèµ·ã™ã‚‹é©æ–°çš„ãªæ–¹æ³•ãŒé–‹ç™ºã•ã‚Œè©¦é¨“ã•ã‚Œã¾ã—ãŸã‹ã€‚",
        "en": "Have innovative types of hand hygiene reminders been developed and tested at the facility?"
    },
    "5.1": {
        "ja": "WHO ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚Šã•ã‚‰ãªã‚‹æ¤œè¨ã®å¿…è¦æ€§ãŒç¤ºã•ã‚ŒãŸèª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€æ–½è¨­ã§æ‰‹æŒ‡è¡›ç”Ÿã«é–¢ã™ã‚‹ç ”ç©¶è¨ˆç”»ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Has a local hand hygiene research agenda addressing issues identified by the WHO Guidelines as requiring further investigation been developed?"
    },
    "5.2": {
        "ja": "æ‰‹æŒ‡è¡›ç”Ÿåˆ†é‡ã«ãŠã„ã¦ã€è‡ªæ–½è¨­ãŒç©æ¥µçš„ã«è«–æ–‡åŒ–ã‚„å­¦ä¼šç™ºè¡¨ï¼ˆå£é ­ã¾ãŸã¯ãƒã‚¹ã‚¿ãƒ¼ï¼‰ã‚’è¡Œã£ã¦ãã¾ã—ãŸã‹ã€‚",
        "en": "Has your facility participated actively in publications or conference presentations (oral or poster) in the area of hand hygiene?"
    },
    "5.3": {
        "ja": "åŒ»ç™‚å¾“äº‹è€…ã®æ‰‹æŒ‡è¡›ç”Ÿå–šèµ·ã«ã€æ‚£è€…ãŒé–¢ä¸ã—ã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Are patients invited to remind health-care workers to perform hand hygiene?"
    },
    "5.4": {
        "ja": "æ‚£è€…ãŠã‚ˆã³è¨ªå•è€…ã«æ­£ã—ã„æ‰‹æŒ‡è¡›ç”Ÿæ³•ã®æ•™è‚²ã‚’ã—ã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Are patients and visitors educated to correctly perform hand hygiene?"
    },
    "5.5": {
        "ja": "è‡ªæ–½è¨­ã¯å›½ã®æ‰‹æŒ‡è¡›ç”Ÿã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ï¼ˆã‚‚ã—å­˜åœ¨ã™ã‚‹ãªã‚‰ã°ï¼‰ã«è²¢çŒ®ã—ã€ã“ã‚Œã‚’æ”¯æ´ã—ã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Does your facility contribute to and support the national hand hygiene campaign (if existing)?"
    },
    "5.6": {
        "ja": "æ‰‹æŒ‡è¡›ç”Ÿã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®åŠ¹æœã«é–¢ã™ã‚‹è©•ä¾¡ã¯ã€æ„ŸæŸ“å¯¾ç­–ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å°†æ¥è¨ˆç”»ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Is impact evaluation of the hand hygiene campaign incorporated into forward planning of the infection control programme?"
    },
    "5.7": {
        "ja": "è‡ªæ–½è¨­ã§ã¯ã€æ–½è¨­å…¨ä½“ã®æ‰‹æŒ‡è¡›ç”Ÿéµå®ˆç‡ã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã«å¹´é–“ç›®æ¨™ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã‹ã€‚",
        "en": "Does your facility set an annual target for improvement of hand hygiene compliance facility-wide?"
    },
    "5.8": {
        "ja": "ç›®æ¨™ã‚’è¨­å®šã—ã¦ã„ã‚‹å ´åˆã€æ˜¨å¹´åº¦ã®ç›®æ¨™ã¯é”æˆã•ã‚Œã¾ã—ãŸã‹ã€‚",
        "en": "If the facility has such a target, was it achieved last year?"
    }
}

# Initialize session state
if "df_processed" not in st.session_state:
    st.session_state.df_processed = None
if "selected_facility_code" not in st.session_state:
    st.session_state.selected_facility_code = None
if "selected_facility_name" not in st.session_state:
    st.session_state.selected_facility_name = None
if "selected_month" not in st.session_state:
    st.session_state.selected_month = None
if "selected_year" not in st.session_state:
    st.session_state.selected_year = None
if "analysis_unit" not in st.session_state:
    st.session_state.analysis_unit = "Year" # Month or Year
if "agg_method" not in st.session_state:
    st.session_state.agg_method = "End" # End, Start, Mean
if "facility_options" not in st.session_state:
    st.session_state.facility_options = []
if "facility_codes" not in st.session_state:
    st.session_state.facility_codes = {}
if "months" not in st.session_state:
    st.session_state.months = []
if "years" not in st.session_state:
    st.session_state.years = []
if "col_mapping" not in st.session_state:
    st.session_state.col_mapping = {}
if "uploader_key" not in st.session_state:
    st.session_state.uploader_key = 0
if "chart_theme" not in st.session_state:
    st.session_state.chart_theme = "Light"
if "active_tab" not in st.session_state:
    st.session_state.active_tab = 0
if "first_interaction_consumed" not in st.session_state:
    st.session_state.first_interaction_consumed = False
if "last_selected_tab" not in st.session_state:
    st.session_state.last_selected_tab = None
if "process_files" not in st.session_state:
    st.session_state.process_files = False
if "uploaded_files_to_process" not in st.session_state:
    st.session_state.uploaded_files_to_process = None

# Reset function (ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã€å…ˆã«å®šç¾©)
def reset_to_top():
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦TOPç”»é¢ã«æˆ»ã‚‹"""
    st.session_state.df_processed = None
    st.session_state.selected_facility_code = None
    st.session_state.selected_facility_name = None
    st.session_state.selected_month = None
    st.session_state.selected_year = None
    st.session_state.facility_options = []
    st.session_state.facility_codes = {}
    st.session_state.months = []
    st.session_state.years = []
    st.session_state.col_mapping = {}
    st.session_state.uploader_key += 1  # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    if "last_uploaded_file" in st.session_state:
        del st.session_state.last_uploaded_file
    if "last_uploaded_files" in st.session_state:
        del st.session_state.last_uploaded_files
    if "uploaded_files_to_process" in st.session_state:
        del st.session_state.uploaded_files_to_process
    if "uploaded_file_names_display" in st.session_state:
        del st.session_state.uploaded_file_names_display

# Sidebar: Configurations
with st.sidebar:
    st.markdown("""
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 3em;">ğŸ¥</div>
        <div style="font-size: 2em; font-weight: 800; line-height: 1.2;">IPC Calc Tools</div>
    </div>
    """, unsafe_allow_html=True)
    
    # è¨€èªè¨­å®šã‚’å…ˆã«å–å¾—ï¼ˆãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã«ä½¿ç”¨ã™ã‚‹ãŸã‚ï¼‰
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ—¥æœ¬èªã‚’ä½¿ç”¨ï¼ˆå¾Œã§è¨­å®šã§å¤‰æ›´å¯èƒ½ï¼‰
    if "lang_selector" not in st.session_state:
        st.session_state.lang_selector = "æ—¥æœ¬èª"
    lang = st.session_state.get("lang_selector", "æ—¥æœ¬èª")
    L = TRANS["ja"] if lang == "æ—¥æœ¬èª" else TRANS["en"]
    
    # TOPç”»é¢ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå¸¸æ™‚è¡¨ç¤ºã€ã‚¿ã‚¤ãƒˆãƒ«ã®ä¸‹ï¼‰
    if st.sidebar.button(L["back_to_top"], help=L["back_to_top_help"], use_container_width=True):
        reset_to_top()
        st.rerun()
    
    st.divider()

# Plotly Template
plotly_template = "plotly" if st.session_state.chart_theme == "Light" else "plotly_dark"

# Plotly Config
plotly_config = {
    "displayModeBar": True,
    "displaylogo": False,
    "modeBarButtonsToRemove": [
        "zoom2d", "pan2d", "select2d", "lasso2d", "zoomIn2d", "zoomOut2d",
        "hoverClosestCartesian", "hoverCompareCartesian", "toggleSpikelines"
    ]
}

# --- Callbacks for UI Sync ---
def on_facility_change():
    display_val = st.session_state.facility_select_main
    code = st.session_state.facility_codes.get(display_val)
    st.session_state.selected_facility_code = code
    st.session_state.selected_facility_name = display_val.split(" (")[0] if " (" in display_val else display_val

def on_month_change():
    if "month_select_main" in st.session_state:
        st.session_state.selected_month = st.session_state.month_select_main
    else:
        st.session_state.selected_month = None
    # åˆå›ã®æ“ä½œã‚’ã€Œæ¶ˆè²»ã€ã™ã‚‹ï¼ˆã‚¿ãƒ–ã®çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆã‚’é˜²ããŸã‚ï¼‰
    if not st.session_state.first_interaction_consumed:
        st.session_state.first_interaction_consumed = True

def on_year_change():
    if "year_select_main" in st.session_state:
        st.session_state.selected_year = st.session_state.year_select_main
    else:
        st.session_state.selected_year = None
    # åˆå›ã®æ“ä½œã‚’ã€Œæ¶ˆè²»ã€ã™ã‚‹ï¼ˆã‚¿ãƒ–ã®çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆã‚’é˜²ããŸã‚ï¼‰
    if not st.session_state.first_interaction_consumed:
        st.session_state.first_interaction_consumed = True

def on_unit_change():
    label = st.session_state.unit_radio_main
    # è¨€èªã«å¿œã˜ãŸãƒ©ãƒ™ãƒ«æ¯”è¼ƒ
    is_month = (label == TRANS["ja"]["unit_month"] or label == TRANS["en"]["unit_month"])
    st.session_state.analysis_unit = "Month" if is_month else "Year"

def on_agg_change():
    # å®Ÿéš›ã®æ›´æ–°ã¯ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—å†…ã§è¡Œã†
    pass

# --- 2. Helper Functions ---
def classify_area(question):
    """è³ªå•ã‚’Areaã«åˆ†é¡"""
    if pd.isna(question) or question == "":
        return None
    q_str = str(question).strip()
    
    # ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ— (Leadership)
    if q_str.startswith("ãƒª") or q_str.startswith("Lea") or "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—" in q_str:
        return "Leadership"
    
    # Area 1: System Change (1.1... or è¿½åŠ /Facility...)
    if q_str.startswith("1") or q_str.startswith("è¿½åŠ ") or q_str.startswith("Add"):
        return "Area1"
    # Area 2: Training & Education
    elif q_str.startswith("2"):
        return "Area2"
    # Area 3: Evaluation & Feedback
    elif q_str.startswith("3"):
        return "Area3"
    # Area 4: Reminders
    elif q_str.startswith("4"):
        return "Area4"
    # Area 5: Safety Climate
    elif q_str.startswith("5"):
        return "Area5"
    
    return None

def get_level_info(score, labels):
    """ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸåˆ¤å®šãƒ¬ãƒ™ãƒ«ã¨è‰²ã‚’è¿”ã—ã¾ã™"""
    if score < 126:
        return labels[0], "#dc3545"  # Red (Inadequate)
    elif score < 251:
        return labels[1], "#ffc107"  # Yellow (Basic)
    elif score < 376:
        return labels[2], "#17a2b8"  # Blue (Intermediate)
    else:
        return labels[3], "#28a745"  # Green (Advanced)

def detect_encoding(file_content_bytes):
    """ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è‡ªå‹•åˆ¤å®š"""
    encodings = ['utf-8', 'shift_jis', 'cp932', 'utf-8-sig']
    for enc in encodings:
        try:
            file_content_bytes.decode(enc)
            return enc
        except:
            continue
    return 'utf-8'

@st.cache_data
def load_data(file):
    """æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•åˆ¤å®šã—ã¦èª­ã¿è¾¼ã¿ã¾ã™"""
    try:
        file.seek(0)
        file_bytes = file.read()
        file.seek(0)
        encoding = detect_encoding(file_bytes)
        file.seek(0)
        return pd.read_csv(file, encoding=encoding)
    except Exception as e:
        st.error(f"Error loading file: {str(e)}")
        return None

def load_multiple_files(uploaded_files):
    """è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§çµåˆã—ã¾ã™"""
    dfs = []
    file_names = []
    
    for uploaded_file in uploaded_files:
        df = load_data(uploaded_file)
        if df is not None:
            dfs.append(df)
            file_names.append(uploaded_file.name)
    
    if not dfs:
        return None, []
    
    # ã™ã¹ã¦ã®DataFrameã‚’çµåˆ
    df_combined = pd.concat(dfs, ignore_index=True)
    return df_combined, file_names

def remove_duplicates(df, code_col, date_col, quest_col):
    """å‡¦æ–¹ç®‹ç™ºè¡ŒåŒ»ç™‚æ©Ÿé–¢ã‚³ãƒ¼ãƒ‰ã€ç™»éŒ²å¹´æœˆã€è³ªå•ã®çµ„ã¿åˆã‚ã›ã§é‡è¤‡ã‚’å‰Šé™¤ï¼ˆæœ€æ–°ã®ç™»éŒ²å¹´æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼‰"""
    if df.empty:
        return df
    
    # é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ã®ã‚­ãƒ¼ã‚«ãƒ©ãƒ ã‚’ç¢ºèª
    key_cols = []
    if code_col in df.columns:
        key_cols.append(code_col)
    if date_col in df.columns:
        key_cols.append(date_col)
    if quest_col in df.columns:
        key_cols.append(quest_col)
    
    if not key_cols:
        return df
    
    # é‡è¤‡ã‚’å‰Šé™¤ï¼ˆæœ€æ–°ã®ç™»éŒ²å¹´æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼‰
    # ç™»éŒ²å¹´æœˆã§é™é †ã‚½ãƒ¼ãƒˆã—ã¦ã€æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    if date_col in df.columns:
        # ç™»éŒ²å¹´æœˆã‚’æ•°å€¤ã¨ã—ã¦ã‚½ãƒ¼ãƒˆï¼ˆæ–‡å­—åˆ—ã¨ã—ã¦ã‚‚æ¯”è¼ƒå¯èƒ½ã ãŒã€æ•°å€¤ã®æ–¹ãŒç¢ºå®Ÿï¼‰
        df_sorted = df.copy()
        # ç™»éŒ²å¹´æœˆã‚’æ•°å€¤ã«å¤‰æ›ï¼ˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å…ƒã®å€¤ã‚’ä¿æŒï¼‰
        try:
            df_sorted['_sort_date'] = pd.to_numeric(df_sorted[date_col], errors='coerce')
            df_sorted = df_sorted.sort_values(by='_sort_date', ascending=False, na_position='last')
            df_sorted = df_sorted.drop(columns=['_sort_date'])
        except:
            # æ•°å€¤å¤‰æ›ã«å¤±æ•—ã—ãŸå ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦ã‚½ãƒ¼ãƒˆ
            df_sorted = df_sorted.sort_values(by=date_col, ascending=False, na_position='last')
        
        df = df_sorted.drop_duplicates(subset=key_cols, keep='first')
        # å…ƒã®é †åºã«æˆ»ã™ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        df = df.sort_index(ascending=True)
    else:
        # ç™»éŒ²å¹´æœˆãŒãªã„å ´åˆã¯ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é™é †ã§ã‚½ãƒ¼ãƒˆã—ã¦æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        df = df.sort_index(ascending=False)
        df = df.drop_duplicates(subset=key_cols, keep='first')
        df = df.sort_index(ascending=True)
    
    return df

def process_raw_data(df_raw, score_col, quest_col, date_col):
    """ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦DataFrameã‚’è¿”ã™"""
    # æ•°å€¤å¤‰æ›ï¼ˆç©ºç™½ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å¤‰æ›ã€NaNã¯ãã®ã¾ã¾ä¿æŒï¼‰
    if score_col in df_raw.columns:
        df_raw[score_col] = df_raw[score_col].astype(str).str.strip()
        # errors='coerce'ã§æ•°å€¤ä»¥å¤–ã¯NaNã«ãªã‚‹
        df_raw[score_col] = pd.to_numeric(df_raw[score_col], errors="coerce")
        # ã“ã“ã§fillna(0)ã¯ã—ãªã„
    
    # ã‚¨ãƒªã‚¢åˆ†é¡
    df_raw["Area"] = df_raw[quest_col].apply(classify_area)
    
    # åˆ†é¡ä¸èƒ½ãªè¡Œã¯é™¤å¤–
    df = df_raw.dropna(subset=["Area"]).copy()
    
    # å¹´æœˆã®æ­£è¦åŒ–ã¨æ–‡å­—åˆ—åŒ–
    if date_col in df.columns:
        df[date_col] = df[date_col].astype(str).str.replace("/", "").str.replace("-", "").str.replace(".", "").str.strip()
        # 4æ¡ã®å¹´ã‚’å–å¾—
        df["Year"] = df[date_col].str[:4]
    
    return df

def get_aggregated_data(df, facility_code, target_date, unit, method, code_col, fac_col, date_col, score_col, quest_col):
    """
    æŒ‡å®šã•ã‚ŒãŸæ¡ä»¶ã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»é›†è¨ˆã™ã‚‹
    unit: "Month" or "Year"
    method: "End", "Start", "Mean" (Yearã®ã¿æœ‰åŠ¹)
    """
    # target_dateãŒNoneã®å ´åˆã€ã¾ãŸã¯facility_codeãŒNoneã®å ´åˆã¯ç©ºã®DataFrameã‚’è¿”ã™
    if target_date is None or facility_code is None:
        return pd.DataFrame()
    
    # 1. æ–½è¨­ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    df_work = df.copy()  # å…ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å¤‰æ›´ã—ãªã„ã‚ˆã†ã«ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
    if code_col in df_work.columns:
        # ã‚³ãƒ¼ãƒ‰åˆ—ã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦æ¯”è¼ƒï¼ˆå‹ã®ä¸ä¸€è‡´ã‚’é˜²ãï¼‰
        df_work[code_col] = df_work[code_col].astype(str)
        facility_code_str = str(facility_code)
        df_fac = df_work[df_work[code_col] == facility_code_str].copy()
    else:
        # facility_codeãŒåå‰ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        facility_code_str = str(facility_code)
        df_work[fac_col] = df_work[fac_col].astype(str)
        df_fac = df_work[df_work[fac_col] == facility_code_str].copy()
        
    if df_fac.empty:
        return df_fac

    # 2. æœŸé–“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»é›†è¨ˆ
    if unit == "Month":
        # æœˆæ¬¡ï¼šå˜ç´”ã«ãã®æœˆã‚’é¸æŠ
        return df_fac[df_fac[date_col] == target_date]
    
    else: # Year
        # å¹´æ¬¡ï¼šãã®å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ
        df_year = df_fac[df_fac["Year"] == target_date].copy()
        
        if df_year.empty:
            return df_year
            
        if method == "End":
            # å¹´ã®æœ€å¾Œï¼ˆæ—¥ä»˜ã§é™é †ã‚½ãƒ¼ãƒˆã—ã¦ã€è³ªå•ã”ã¨ã«æœ€åˆã®ã‚‚ã®ã‚’å–å¾—ï¼æœ€æ–°ï¼‰
            df_year = df_year.sort_values(by=date_col, ascending=False)
            return df_year.drop_duplicates(subset=[quest_col], keep="first")
            
        elif method == "Start":
            # å¹´ã®åˆã‚ï¼ˆæ—¥ä»˜ã§æ˜‡é †ã‚½ãƒ¼ãƒˆã—ã¦ã€è³ªå•ã”ã¨ã«æœ€åˆã®ã‚‚ã®ã‚’å–å¾—ï¼æœ€å¤ï¼‰
            df_year = df_year.sort_values(by=date_col, ascending=True)
            return df_year.drop_duplicates(subset=[quest_col], keep="first")
            
        elif method == "Mean":
            # å¹³å‡ï¼šè³ªå•ã”ã¨ã«å¹³å‡ã‚’ç®—å‡º
            numeric_cols = [score_col]
            group_cols = [quest_col, "Area", "Year"]
            
            df_mean = df_year.groupby(group_cols)[numeric_cols].mean().reset_index()
            
            # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            if len(df_year) > 0:
                meta_info = df_year.iloc[0].to_dict()
                for col in df_year.columns:
                    if col not in df_mean.columns:
                        df_mean[col] = meta_info.get(col)
            
            return df_mean
            
    return pd.DataFrame()

# --- 3. Main Application Logic ---
st.title(L["title"])
st.caption(L["subtitle"])

# è¨€èªè¨­å®šã‚’å†å–å¾—ï¼ˆè¨­å®šexpanderã§å¤‰æ›´ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
lang = st.session_state.get("lang_selector", "æ—¥æœ¬èª")
L = TRANS["ja"] if lang == "æ—¥æœ¬èª" else TRANS["en"]

# Sidebar: File Uploadï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
target_filename = "ICTé–¢é€£æƒ…å ±_WHOæ‰‹æŒ‡è¡›ç”Ÿè‡ªå·±è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯_è©³ç´°.csv"

st.sidebar.header("Data Input")

# ãƒ•ã‚¡ã‚¤ãƒ«åãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¨­å®š
use_filename_filter = st.sidebar.checkbox(
    f"ãƒ•ã‚¡ã‚¤ãƒ«åã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: {target_filename}",
    value=True,
    help="ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚è¤‡æ•°ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚"
)

help_text = f"{L['upload_help']}\\n\\nåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«åã§ã‚‚è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚\\nãƒ•ã‚¡ã‚¤ãƒ«åãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒæœ‰åŠ¹ãªå ´åˆã€'{target_filename}'ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚"
uploaded_files = st.sidebar.file_uploader(
    L["upload_label"], 
    type=["csv"], 
    help=help_text, 
    key=f"file_uploader_{st.session_state.uploader_key}",
    accept_multiple_files=True
)
st.sidebar.caption(L["memory_warning"])

# ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ•ãƒ©ã‚°
data_ready = False

# ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ–°ã—ãã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå ´åˆã€ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä¿å­˜ï¼ˆå‡¦ç†ã¯å®Ÿè¡Œãƒœã‚¿ãƒ³ã§é–‹å§‹ï¼‰
if uploaded_files is not None and len(uploaded_files) > 0:
    # ãƒ•ã‚¡ã‚¤ãƒ«åãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é©ç”¨
    if use_filename_filter:
        filtered_files = [f for f in uploaded_files if f.name == target_filename]
        if len(filtered_files) == 0:
            st.sidebar.warning(f"âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«å '{target_filename}' ã«ä¸€è‡´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚{len(uploaded_files)}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸãŒã€ã™ã¹ã¦ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚")
            uploaded_files = []
        elif len(filtered_files) < len(uploaded_files):
            skipped_count = len(uploaded_files) - len(filtered_files)
            st.sidebar.info(f"â„¹ï¸ {len(filtered_files)}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸï¼ˆ{skipped_count}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸï¼‰ã€‚")
            uploaded_files = filtered_files
        else:
            uploaded_files = filtered_files
    
    if len(uploaded_files) > 0:
        # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆã‚½ãƒ¼ãƒˆã—ã¦æ¯”è¼ƒï¼‰
        uploaded_file_names = sorted([f.name for f in uploaded_files])
        uploaded_file_names_str = ",".join(uploaded_file_names)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        if "last_uploaded_files" not in st.session_state or st.session_state.last_uploaded_files != uploaded_file_names_str:
            # æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
            st.session_state.df_processed = None
            st.session_state.selected_facility_code = None
            st.session_state.selected_facility_name = None
            st.session_state.selected_month = None
            st.session_state.selected_year = None
            st.session_state.last_uploaded_files = uploaded_file_names_str
            st.session_state.uploaded_files_to_process = uploaded_files  # å‡¦ç†å¾…ã¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
            # åˆå›ã®æ“ä½œã‚’ã€Œæ¶ˆè²»ã€ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãŸã‚ï¼‰
            st.session_state.first_interaction_consumed = False
            # å‡¦ç†æ¸ˆã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤ºã‚‚ã‚¯ãƒªã‚¢
            if "uploaded_file_names_display" in st.session_state:
                del st.session_state.uploaded_file_names_display
            # å‡¦ç†ãƒ•ãƒ©ã‚°ã‚‚ãƒªã‚»ãƒƒãƒˆ
            st.session_state.process_files = False
        
        # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
        file_names_to_display = None
        if "uploaded_files_to_process" in st.session_state and st.session_state.uploaded_files_to_process:
            # å‡¦ç†å‰ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
            file_names_to_display = [f.name for f in st.session_state.uploaded_files_to_process]
        elif "uploaded_file_names_display" in st.session_state and st.session_state.uploaded_file_names_display:
            # å‡¦ç†å¾Œï¼šä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½¿ç”¨
            file_names_to_display = st.session_state.uploaded_file_names_display
        
        if file_names_to_display:
            st.sidebar.markdown("---")
            st.sidebar.markdown("### ğŸ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«")
            for i, file_name in enumerate(file_names_to_display, 1):
                st.sidebar.text(f"{i}. {file_name}")
            st.sidebar.markdown(f"**åˆè¨ˆ: {len(file_names_to_display)}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«**")
            
            # å®Ÿè¡Œãƒœã‚¿ãƒ³ï¼ˆãƒ‡ãƒ¼ã‚¿æœªå‡¦ç†æ™‚ã®ã¿è¡¨ç¤ºï¼‰
            if st.session_state.df_processed is None:
                if st.sidebar.button("ğŸš€ é›†è¨ˆã‚’é–‹å§‹", type="primary", use_container_width=True):
                    st.session_state.process_files = True
                    st.rerun()

# å®Ÿè¡Œãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
if st.session_state.get("process_files", False) and "uploaded_files_to_process" in st.session_state and st.session_state.uploaded_files_to_process:
    uploaded_files_to_process = st.session_state.uploaded_files_to_process
    st.session_state.process_files = False  # ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ500MBåˆ¶é™ï¼‰
    MAX_FILE_SIZE_MB = 500
    MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024
    total_size = sum(file.size for file in uploaded_files_to_process)
    total_size_mb = total_size / (1024 * 1024)
    
    if total_size > MAX_FILE_SIZE_BYTES:
        st.sidebar.error(L["err_file_size_exceeded"])
        st.sidebar.error(L["err_file_size_detail"].format(total_mb=total_size_mb))
        # å‡¦ç†ã‚’ä¸­æ–­
        if "uploaded_files_to_process" in st.session_state:
            del st.session_state.uploaded_files_to_process
        st.session_state.process_files = False  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
    else:
        # ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
        df_raw = None
        file_names = []
        
        try:
            # è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§çµåˆ
            if len(uploaded_files_to_process) == 1:
                df_raw = load_data(uploaded_files_to_process[0])
                file_names = [uploaded_files_to_process[0].name]
            else:
                df_raw, file_names = load_multiple_files(uploaded_files_to_process)
                if df_raw is not None:
                    st.sidebar.success(f"âœ… {len(uploaded_files_to_process)}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: {', '.join(file_names)}")
        except Exception as e:
            st.sidebar.error(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
            import traceback
            st.sidebar.code(traceback.format_exc())
            if "uploaded_files_to_process" in st.session_state:
                del st.session_state.uploaded_files_to_process
            df_raw = None
            st.session_state.process_files = False  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
        
        if df_raw is not None:
            try:
                # ã‚«ãƒ©ãƒ åã®æ¤œå‡º
                cols = df_raw.columns
                score_col = "ã‚¹ã‚³ã‚¢" if "ã‚¹ã‚³ã‚¢" in cols else ([c for c in cols if "core" in c.lower() or "score" in c.lower()] + ["Score"])[0]
                quest_col = "è³ªå•" if "è³ªå•" in cols else ([c for c in cols if "question" in c.lower()] + ["Question"])[0]
                date_col = "ç™»éŒ²å¹´æœˆ" if "ç™»éŒ²å¹´æœˆ" in cols else ([c for c in cols if "date" in c.lower() or "month" in c.lower()] + ["Date"])[0]
                fac_col = "æ–½è¨­å" if "æ–½è¨­å" in cols else ([c for c in cols if "facility" in c.lower()] + ["Facility"])[0]
                code_col = "å‡¦æ–¹ç®‹ç™ºè¡ŒåŒ»ç™‚æ©Ÿé–¢ã‚³ãƒ¼ãƒ‰" if "å‡¦æ–¹ç®‹ç™ºè¡ŒåŒ»ç™‚æ©Ÿé–¢ã‚³ãƒ¼ãƒ‰" in cols else ([c for c in cols if "code" in c.lower() or "id" in c.lower()] + ["Code"])[0]
                
                # ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                df = process_raw_data(df_raw, score_col, quest_col, date_col)
                
                # é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ï¼ˆå‡¦æ–¹ç®‹ç™ºè¡ŒåŒ»ç™‚æ©Ÿé–¢ã‚³ãƒ¼ãƒ‰ã€ç™»éŒ²å¹´æœˆã€è³ªå•ã®çµ„ã¿åˆã‚ã›ã§é‡è¤‡ã‚’å‰Šé™¤ï¼‰
                df_before = len(df)
                df = remove_duplicates(df, code_col, date_col, quest_col)
                df_after = len(df)
                if df_before > df_after:
                    st.sidebar.info(f"â„¹ï¸ é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: {df_before}è¡Œ â†’ {df_after}è¡Œ ({df_before - df_after}è¡Œå‰Šé™¤)")
                
                # IDåˆ—ã‚’æ–‡å­—åˆ—ã«å¤‰æ›
                if code_col in df.columns:
                    df[code_col] = df[code_col].astype(str).str.replace(r"\.0$", "", regex=True)
                
                # ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ç”¨ãƒªã‚¹ãƒˆã®ä½œæˆ
                if fac_col in df.columns and code_col in df.columns:
                    facilities = df[[code_col, fac_col]].drop_duplicates()
                    facility_options = [f"{row[fac_col]} ({row[code_col]})" for _, row in facilities.iterrows()]
                    facility_codes = {f"{row[fac_col]} ({row[code_col]})": row[code_col] for _, row in facilities.iterrows()}
                else:
                    facilities = df[fac_col].unique() if fac_col in df.columns else ["Unknown"]
                    facility_options = list(facilities)
                    facility_codes = {f: f for f in facility_options}
                
                months = sorted(df[date_col].unique()) if date_col in df.columns else ["Unknown"]
                years = sorted(df["Year"].unique()) if "Year" in df.columns else ["Unknown"]
                
                # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã«ä¿å­˜
                st.session_state.df_processed = df
                st.session_state.facility_options = facility_options
                st.session_state.facility_codes = facility_codes
                st.session_state.months = months
                st.session_state.years = years
                st.session_state.col_mapping = {
                    "score_col": score_col,
                    "quest_col": quest_col,
                    "date_col": date_col,
                    "fac_col": fac_col,
                    "code_col": code_col
                }
                
                # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿å‡¦ç†ãŒå®Œäº†ã—ãŸå¾Œï¼‰
                if st.session_state.selected_facility_code is None and facility_options:
                    st.session_state.selected_facility_code = facility_codes.get(facility_options[0] if facility_options else None)
                    st.session_state.selected_facility_name = facility_options[0].split(" (")[0] if facility_options and " (" in facility_options[0] else (facility_options[0] if facility_options else None)
                if st.session_state.selected_month is None and months:
                    st.session_state.selected_month = months[-1] if months else None
                if st.session_state.selected_year is None and years:
                    st.session_state.selected_year = years[-1] if years else None
                
                # å‡¦ç†å®Œäº†å¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«åæƒ…å ±ã‚’ä¿å­˜ï¼ˆè¡¨ç¤ºã®ãŸã‚ï¼‰
                if "uploaded_files_to_process" in st.session_state and st.session_state.uploaded_files_to_process:
                    st.session_state.uploaded_file_names_display = [f.name for f in st.session_state.uploaded_files_to_process]
                    # å‡¦ç†å¾…ã¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å‰Šé™¤ï¼ˆãƒ¡ãƒ¢ãƒªç¯€ç´„ã®ãŸã‚ï¼‰
                    del st.session_state.uploaded_files_to_process
                
                st.sidebar.success("âœ… ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
            except Exception as e:
                st.sidebar.error(f"âŒ ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                import traceback
                st.sidebar.code(traceback.format_exc())
                if "uploaded_files_to_process" in st.session_state:
                    del st.session_state.uploaded_files_to_process
                st.session_state.process_files = False  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
        else:
            # df_rawãŒNoneã®å ´åˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå ´åˆï¼‰
            st.sidebar.error("âŒ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
            if "uploaded_files_to_process" in st.session_state:
                del st.session_state.uploaded_files_to_process
            st.session_state.process_files = False  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

# è¨­å®šexpanderï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ä¸€ç•ªä¸‹ã«é…ç½®ã€å¸¸ã«è¡¨ç¤ºï¼‰
st.sidebar.divider()
with st.sidebar.expander("âš™ï¸ è¨­å®š / Settings", expanded=False):
    # Language Selection
    st.markdown("### Language / è¨€èª")
    lang = st.radio("Language", ["æ—¥æœ¬èª", "English"], label_visibility="collapsed", key="lang_selector")
    L = TRANS["ja"] if lang == "æ—¥æœ¬èª" else TRANS["en"]
    
    st.divider()
    
    # Chart Theme Selection
    st.markdown(f"### {L['chart_theme']}")
    theme_options = [L["theme_light"], L["theme_dark"]]
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‹ã‚‰ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
    current_theme_idx = 0 if st.session_state.chart_theme == "Light" else 1
    
    # ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    selected_theme_label = st.radio(
        L["chart_theme"], 
        theme_options, 
        index=current_theme_idx, 
        label_visibility="collapsed", 
        key="theme_selector_radio"
    )
    
    # é¸æŠã•ã‚ŒãŸãƒ©ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ãƒ†ãƒ¼ãƒã‚’æ±ºå®š
    new_theme = "Light" if selected_theme_label == L["theme_light"] else "Dark"
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆã‚‚ã—å¤‰æ›´ãŒã‚ã‚Œã°ï¼‰
    if st.session_state.chart_theme != new_theme:
        st.session_state.chart_theme = new_theme
        # st.rerun()ã‚’å‰Šé™¤ã—ã¦ã€è‡ªå‹•æ›´æ–°ã«ä»»ã›ã‚‹ï¼ˆã‚¿ãƒ–ã®é¸æŠçŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ãŸã‚ï¼‰
        
    st.caption(L["theme_note"])

# GitHubãƒªãƒ³ã‚¯ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼æœ€ä¸‹éƒ¨ï¼‰
st.sidebar.divider()
st.sidebar.markdown(f"### {L['github_link']}")
st.sidebar.markdown(f"<small>{L['github_desc']}</small>", unsafe_allow_html=True)
st.sidebar.markdown(
    f'<a href="https://github.com/ipc-calc-tools/ipc-calc-tools.github.io" target="_blank" style="text-decoration: none; color: inherit;">'
    f'<div style="background-color: #24292e; color: white; padding: 10px; border-radius: 5px; text-align: center; margin-top: 10px;">'
    f'{L["github_open"]}'
    f'</div></a>',
    unsafe_allow_html=True
)

# ãƒ‡ãƒ¼ã‚¿ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚ã‚‹å ´åˆï¼ˆè¨€èªåˆ‡ã‚Šæ›¿ãˆæ™‚ã‚‚ã“ã“ã‚’é€šã‚‹ï¼‰
if st.session_state.df_processed is not None:
    data_ready = True
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
    df = st.session_state.df_processed
    score_col = st.session_state.col_mapping.get("score_col", "ã‚¹ã‚³ã‚¢")
    quest_col = st.session_state.col_mapping.get("quest_col", "è³ªå•")
    date_col = st.session_state.col_mapping.get("date_col", "ç™»éŒ²å¹´æœˆ")
    fac_col = st.session_state.col_mapping.get("fac_col", "æ–½è¨­å")
    code_col = st.session_state.col_mapping.get("code_col", "å‡¦æ–¹ç®‹ç™ºè¡ŒåŒ»ç™‚æ©Ÿé–¢ã‚³ãƒ¼ãƒ‰")
    facility_options = st.session_state.facility_options
    facility_codes = st.session_state.facility_codes
    months = st.session_state.months
    years = st.session_state.get("years", [])
    
    # --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ UI (Main Area) ---
    with st.container():
        # 1è¡Œç›®: åˆ†æå˜ä½ & é›†è¨ˆæ–¹æ³•
        c1, c2 = st.columns([1, 2])
        with c1:
            st.markdown(f"##### {L['analysis_unit']}")
            unit_options = [L["unit_month"], L["unit_year"]]
            unit_idx = 0 if st.session_state.analysis_unit == "Month" else 1
            
            st.radio(
                L["analysis_unit"], 
                unit_options, 
                index=unit_idx, 
                label_visibility="collapsed", 
                horizontal=True, 
                key="unit_radio_main",
                on_change=on_unit_change
            )
        
        with c2:
            if st.session_state.analysis_unit == "Year":
                st.markdown(f"##### {L['agg_method']}")
                agg_options = {
                    L["agg_end"]: "End",
                    L["agg_start"]: "Start",
                    L["agg_mean"]: "Mean"
                }
                current_agg = st.session_state.agg_method
                agg_values = list(agg_options.values())
                try:
                    agg_idx = agg_values.index(current_agg)
                except ValueError:
                    agg_idx = 0
                
                selected_agg_label = st.selectbox(
                    L["agg_method"],
                    list(agg_options.keys()),
                    index=agg_idx,
                    label_visibility="collapsed",
                    key="agg_select_main"
                )
                # é¸æŠçµæœã‚’åæ˜ 
                st.session_state.agg_method = agg_options[selected_agg_label]
        
        st.divider()
        
        # 2è¡Œç›®: æ–½è¨­é¸æŠ & å¹´æœˆé¸æŠ
        col1, col2 = st.columns(2)
        with col1:
            # ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹æ–½è¨­ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            current_facility_idx = 0
            if st.session_state.selected_facility_code and facility_options:
                for idx, opt in enumerate(facility_options):
                    if facility_codes.get(opt) == st.session_state.selected_facility_code:
                        current_facility_idx = idx
                        break
            
            st.selectbox(
                L["select_facility"], 
                facility_options, 
                index=current_facility_idx,
                key="facility_select_main",
                on_change=on_facility_change
            )
            # å¤‰æ•°ã¯ on_change ã§æ›´æ–°æ¸ˆã¿ãªã®ã§ã€ã“ã“ã§ã¯ session_state ã‹ã‚‰èª­ã¿å‡ºã™
            selected_facility_code = st.session_state.selected_facility_code
            selected_facility_name = st.session_state.selected_facility_name
        
        with col2:
            if st.session_state.analysis_unit == "Month":
                # æœˆé¸æŠ
                current_month_idx = 0
                if st.session_state.selected_month and months:
                    try:
                        current_month_idx = months.index(st.session_state.selected_month)
                    except (ValueError, AttributeError):
                        current_month_idx = len(months) - 1 if months else 0
                
                if months:
                    st.selectbox(
                        L["select_month"], 
                        months, 
                        index=current_month_idx, 
                        key="month_select_main",
                        on_change=on_month_change
                    )
                    # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã‚‚æœ€æ–°ã®å€¤ã‚’å–å¾—
                    if "month_select_main" in st.session_state:
                        target_date = st.session_state.month_select_main
                    else:
                        target_date = st.session_state.selected_month
                else:
                    st.info("åˆ©ç”¨å¯èƒ½ãªæœˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
                    target_date = None
            else:
                # å¹´é¸æŠ
                current_year_idx = 0
                if st.session_state.selected_year and years:
                    try:
                        current_year_idx = years.index(st.session_state.selected_year)
                    except (ValueError, AttributeError):
                        current_year_idx = len(years) - 1 if years else 0
                        
                if years:
                    st.selectbox(
                        L["select_year"],
                        years,
                        index=current_year_idx,
                        key="year_select_main",
                        on_change=on_year_change
                    )
                    # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã‚‚æœ€æ–°ã®å€¤ã‚’å–å¾—
                    if "year_select_main" in st.session_state:
                        target_date = st.session_state.year_select_main
                    else:
                        target_date = st.session_state.selected_year
                else:
                    st.info("åˆ©ç”¨å¯èƒ½ãªå¹´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
                    target_date = None
    
    # --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ & é›†è¨ˆ ---
    try:
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®å†ç¢ºèªï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‹ã‚‰å–å¾—ï¼‰
        if selected_facility_code is None and facility_options:
            selected_facility_code = facility_codes.get(facility_options[0] if facility_options else None)
            st.session_state.selected_facility_code = selected_facility_code
            st.session_state.selected_facility_name = facility_options[0].split(" (")[0] if facility_options and " (" in facility_options[0] else (facility_options[0] if facility_options else None)
        
        if target_date is None:
            if st.session_state.analysis_unit == "Month" and months:
                target_date = months[-1] if months else None
                st.session_state.selected_month = target_date
            elif st.session_state.analysis_unit == "Year" and years:
                target_date = years[-1] if years else None
                st.session_state.selected_year = target_date
        
        # target_dateãŒNoneã®å ´åˆã€ã¾ãŸã¯selected_facility_codeãŒNoneã®å ´åˆã¯ç©ºã®DataFrameã‚’è¿”ã™
        if target_date is None or selected_facility_code is None:
            if target_date is None:
                st.warning("âš ï¸ å¹´æœˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")
            if selected_facility_code is None:
                st.warning("âš ï¸ æ–½è¨­ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")
            df_filtered = pd.DataFrame()
        else:
            df_filtered = get_aggregated_data(
                df, 
                selected_facility_code, 
                target_date, 
                st.session_state.analysis_unit, 
                st.session_state.agg_method,
                code_col, fac_col, date_col, score_col, quest_col
            )
    except Exception as e:
        st.error(f"ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        import traceback
        st.code(traceback.format_exc())
        df_filtered = pd.DataFrame()
    
    if df_filtered.empty:
        st.info(L["no_data"])
    else:
        # --- ã‚¹ã‚³ã‚¢è¨ˆç®— ---
        # ãƒ‡ãƒ¼ã‚¿æ¬ æã®ãƒã‚§ãƒƒã‚¯
        if df_filtered[score_col].isna().any():
            null_count = df_filtered[score_col].isna().sum()
            st.warning(f"âš ï¸ {null_count} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¬ æã—ã¦ã„ã¾ã™ï¼ˆã‚¹ã‚³ã‚¢ãŒç©ºç™½ã€ã¾ãŸã¯æ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚ã“ã‚Œã‚‰ã¯ 0ç‚¹ ã¨ã—ã¦è¨ˆç®—ã•ã‚Œã¾ã™ã€‚")
        
        # è¨ˆç®—ç”¨ã«0åŸ‹ã‚ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
        try:
            df_calc = df_filtered.copy()
            df_calc[score_col] = df_calc[score_col].fillna(0)
            
            # Areaåˆ—ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
            if "Area" not in df_calc.columns:
                st.error("ãƒ‡ãƒ¼ã‚¿ã«'Area'åˆ—ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚")
                df_calc = pd.DataFrame()
            
            if not df_calc.empty:
                area_scores = df_calc[df_calc["Area"] != "Leadership"].groupby("Area")[score_col].sum()
                leadership_data = df_calc[df_calc["Area"] == "Leadership"]
                leadership_score = float(leadership_data[score_col].sum()) if len(leadership_data) > 0 else 0.0
                scores_list = [float(area_scores.get(f"Area{i}", 0)) for i in range(1, 6)]
                total_score = sum(scores_list)
            else:
                area_scores = pd.Series()
                leadership_data = pd.DataFrame()
                leadership_score = 0.0
                scores_list = [0.0] * 5
                total_score = 0.0
        except Exception as e:
            st.error(f"ã‚¹ã‚³ã‚¢è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
            import traceback
            st.code(traceback.format_exc())
            area_scores = pd.Series()
            leadership_data = pd.DataFrame()
            leadership_score = 0.0
            scores_list = [0.0] * 5
            total_score = 0.0
        
        # --- ã‚¿ãƒ– UI ---
        # ã‚¿ãƒ–ã®é¸æŠçŠ¶æ…‹ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã§æ˜ç¤ºçš„ã«ç®¡ç†
        tab_names = [L["tab_dashboard"], L["tab_timeseries"], L["tab_comparison"], L["tab_leadership"]]
        
        # ç¾åœ¨ã®ã‚¿ãƒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‹ã‚‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯0ï¼‰
        if "tab_selector" not in st.session_state:
            st.session_state.tab_selector = 0
        
        # ã‚¿ãƒ–é¸æŠç”¨ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼ˆæ°´å¹³é…ç½®ï¼‰
        selected_tab_idx = st.radio(
            "ã‚¿ãƒ–é¸æŠ",
            options=range(len(tab_names)),
            format_func=lambda x: tab_names[x],
            horizontal=True,
            label_visibility="collapsed",
            key="tab_selector",
            index=st.session_state.tab_selector
        )
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆtab_selectorã¯è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹ãŒã€active_tabã‚‚æ›´æ–°ï¼‰
        st.session_state.active_tab = selected_tab_idx
        
        # é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã«å¿œã˜ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
        if selected_tab_idx == 0:
            # --- Tab 1: Dashboard ---
            level_label, level_color = get_level_info(total_score, L["level_labels"])
            
            m1, m2, m3 = st.columns(3)
            m1.metric(L["total_score"], f"{int(total_score)} / 500")
            
            m2.markdown(
                f"<div style='text-align: center;'><span style='background-color:{level_color}; padding:4px 12px; border-radius:16px; color:white; font-weight:bold; font-size:1.2em'>{level_label}</span></div>", 
                unsafe_allow_html=True
            )
            
            if total_score >= 376:
                m3.metric(L["leadership_score"], f"{int(leadership_score)} / 100", L["eligible"])
            else:
                m3.metric(L["leadership_score"], "-", L["not_eligible"])
            
            st.divider()
            
            # ã‚°ãƒ©ãƒ•ã®ã‚­ãƒ¼ç”Ÿæˆç”¨ã®å®‰å…¨ãªå€¤
            safe_target_date = str(target_date) if target_date is not None else "none"
            safe_facility_code = str(selected_facility_code) if selected_facility_code is not None else "none"
            
            c1, c2 = st.columns([3, 2])
            
            with c1:
                fig_radar = go.Figure()
                fig_radar.add_trace(go.Scatterpolar(
                    r=scores_list,
                    theta=L["area_labels"],
                    fill="toself",
                    name=selected_facility_name,
                    line_color="#667eea",
                    fillcolor="rgba(102, 126, 234, 0.3)"
                ))
                fig_radar.update_layout(
                    template=plotly_template,
                    dragmode=False,
                    polar=dict(
                        radialaxis=dict(visible=True, range=[0, 100], tickfont=dict(size=10)),
                        angularaxis=dict(tickfont=dict(size=12))
                    ),
                    title=dict(text=L["radar_title"], x=0.5),
                    margin=dict(l=60, r=60, t=40, b=40),
                    height=450
                )
                st.plotly_chart(fig_radar, use_container_width=True, config=plotly_config, key=f"radar_{safe_target_date}_{safe_facility_code}")
                
            with c2:
                fig_donut = go.Figure(data=[go.Pie(
                    labels=["Obtained", "Remaining"],
                    values=[total_score, 500-total_score],
                    hole=.7,
                    marker_colors=[level_color, "#f0f2f6"],
                    textinfo="none",
                    sort=False,
                    direction="clockwise"
                )])
                fig_donut.update_layout(
                    template=plotly_template,
                    title=dict(text=L["total_score"], x=0.5),
                    annotations=[dict(
                        text=f"{int(total_score)}", 
                        x=0.5, y=0.5, 
                        font_size=40, 
                        showarrow=False, 
                        font_weight="bold"
                    )],
                    showlegend=False,
                    margin=dict(l=20, r=20, t=40, b=20),
                    height=350
                )
                st.plotly_chart(fig_donut, use_container_width=True, config=plotly_config, key=f"donut_{safe_target_date}_{safe_facility_code}")
            
            # 2è¡Œç›®: é”æˆç‡ãƒãƒ¼ã‚°ãƒ©ãƒ•ï¼ˆå…¨å¹…ï¼‰
            # é”æˆç‡ãƒãƒ¼ã‚°ãƒ©ãƒ•ï¼ˆProgress Bar Chartï¼‰
            try:
                # å„ã‚¨ãƒªã‚¢ã®é”æˆç‡ã‚’è¨ˆç®—ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰
                area_names = L["area_labels"]
                area_scores_values = scores_list
                max_score = 100.0  # å„ã‚¨ãƒªã‚¢ã®æœ€å¤§ã‚¹ã‚³ã‚¢ã¯100ç‚¹
                
                # ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
                if not area_names or not area_scores_values or len(area_names) != len(area_scores_values):
                    st.warning("ã‚¨ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚")
                else:
                    # é”æˆç‡ã‚’è¨ˆç®—ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰
                    achievement_rates = [(float(score) / max_score * 100) if max_score > 0 else 0.0 for score in area_scores_values]
                    
                    # é †ç•ªã‚’é€†ã«ã—ã¦ã€ã‚·ã‚¹ãƒ†ãƒ å¤‰é©ã‚’ä¸€ç•ªä¸Šã«è¡¨ç¤º
                    area_names_reversed = list(reversed(area_names))
                    achievement_rates_reversed = list(reversed(achievement_rates))
                    
                    # æ¨ªæ£’ã‚°ãƒ©ãƒ•ã§é”æˆç‡ã‚’è¡¨ç¤º
                    # è‰²ã®è¨­å®šï¼ˆé”æˆç‡ã«å¿œã˜ã¦ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                    colors = []
                    for rate in achievement_rates_reversed:
                        if rate < 50:
                            colors.append("#e74c3c")  # èµ¤
                        elif rate < 75:
                            colors.append("#f39c12")  # ã‚ªãƒ¬ãƒ³ã‚¸
                        elif rate < 90:
                            colors.append("#3498db")  # é’
                        else:
                            colors.append("#2ecc71")  # ç·‘
                    
                    fig_progress = go.Figure(data=[go.Bar(
                        x=achievement_rates_reversed,
                        y=area_names_reversed,
                        orientation='h',
                        marker_color=colors,
                        text=[f"{rate:.1f}%" for rate in achievement_rates_reversed],
                        textposition='auto',
                        textfont=dict(size=11, color="white")
                    )])
                    
                    fig_progress.update_layout(
                        template=plotly_template,
                        title=dict(text=L["progress_bar_title"], x=0.5),
                        xaxis=dict(title="Achievement Rate (%)", range=[0, 105]),
                        yaxis=dict(title=""),
                        margin=dict(l=20, r=20, t=40, b=40),
                        height=350,
                        showlegend=False
                    )
                    st.plotly_chart(fig_progress, use_container_width=True, config=plotly_config, key=f"progress_{safe_target_date}_{safe_facility_code}")
            except Exception as e:
                st.error(f"é”æˆç‡ãƒãƒ¼ã‚°ãƒ©ãƒ•ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                import traceback
                st.code(traceback.format_exc())
            
            # 3è¡Œç›®: è©³ç´°è³ªå•ã‚¹ã‚³ã‚¢ã®å±•é–‹ãƒ†ãƒ¼ãƒ–ãƒ«
            st.subheader(L["question_detail_title"])
            try:
                # df_filteredã‹ã‚‰å„ã‚¨ãƒªã‚¢ã”ã¨ã®è³ªå•é …ç›®ã¨ã‚¹ã‚³ã‚¢ã‚’å–å¾—
                if not df_filtered.empty and "Area" in df_filtered.columns and quest_col in df_filtered.columns and score_col in df_filtered.columns:
                    # ã‚¨ãƒªã‚¢ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆLeadershipã¯é™¤å¤–ï¼‰
                    for area_idx in range(1, 6):
                        area_name = f"Area{area_idx}"
                        area_display_name = L["area_labels"][area_idx - 1]
                        
                        # è©²å½“ã‚¨ãƒªã‚¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        area_data = df_filtered[df_filtered["Area"] == area_name].copy()
                        
                        if not area_data.empty:
                            # ã‚¹ã‚³ã‚¢ã‚’æ•°å€¤ã«å¤‰æ›ï¼ˆNaNã¯0ã¨ã—ã¦æ‰±ã†ï¼‰
                            area_data[score_col] = pd.to_numeric(area_data[score_col], errors='coerce').fillna(0)
                            
                            # ã‚¨ãƒªã‚¢åˆè¨ˆã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
                            area_total_score = float(area_data[score_col].sum())
                            
                            # Expanderã§å±•é–‹å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
                            with st.expander(f"ğŸ“ {area_display_name} (åˆè¨ˆ: {int(area_total_score)}ç‚¹)", expanded=False):
                                # è³ªå•é …ç›®ã¨ã‚¹ã‚³ã‚¢ã‚’ã‚½ãƒ¼ãƒˆï¼ˆè³ªå•ç•ªå·é †ï¼‰
                                area_data_sorted = area_data.sort_values(by=quest_col).copy()
                                
                                # ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ
                                table_data = {
                                    L["question_label"]: area_data_sorted[quest_col].tolist(),
                                    L["score_label"]: [int(float(score)) for score in area_data_sorted[score_col].tolist()]
                                }
                                df_table = pd.DataFrame(table_data)
                                
                                # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º
                                st.dataframe(
                                    df_table,
                                    use_container_width=True,
                                    hide_index=True,
                                    column_config={
                                        L["question_label"]: st.column_config.TextColumn(
                                            L["question_label"],
                                            width="large"
                                        ),
                                        L["score_label"]: st.column_config.NumberColumn(
                                            L["score_label"],
                                            format="%dç‚¹"
                                        )
                                    }
                                )
                                
                                # ã‚¨ãƒªã‚¢åˆè¨ˆã‚’è¡¨ç¤º
                                st.caption(f"ğŸ’¡ {L['area_total']}: {int(area_total_score)}ç‚¹")
                        else:
                            # ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã‚‚Expanderã‚’è¡¨ç¤ºï¼ˆç©ºã®çŠ¶æ…‹ï¼‰
                            with st.expander(f"ğŸ“ {area_display_name} (åˆè¨ˆ: 0ç‚¹)", expanded=False):
                                st.info(L["no_data"])
                else:
                    st.warning("ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚è©³ç´°è³ªå•ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚")
            except Exception as e:
                st.error(f"è©³ç´°è³ªå•ã‚¹ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                import traceback
                st.code(traceback.format_exc())
    
        elif selected_tab_idx == 1:
            # --- Tab 2: Time Series ---
            st.subheader(f"{selected_facility_name} - {L['time_series_title']}")
            
            if code_col in df.columns:
                df_facility = df[df[code_col] == selected_facility_code].copy()
            else:
                df_facility = df[df[fac_col] == selected_facility_name].copy()
            
            if not df_facility.empty:
                # é›†è¨ˆå˜ä½ï¼ˆAnalysis Unitï¼‰ã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
                if st.session_state.analysis_unit == "Month":
                    # æœˆæ¬¡æ¨ç§» (Month vs Score)
                    df_ts = df_facility[df_facility["Area"] != "Leadership"].groupby([date_col, "Area"])[score_col].sum().unstack(fill_value=0)
                    xaxis_title = "Month"
                else:
                    # å¹´æ¬¡æ¨ç§» (Year vs Score)
                    agg_method_ts = st.session_state.agg_method
                    
                    ts_data = []
                    for y in sorted(df_facility["Year"].unique()):
                        df_y = df_facility[df_facility["Year"] == y]
                        
                        if agg_method_ts == "End":
                            df_y = df_y.sort_values(by=date_col, ascending=False).drop_duplicates(subset=[quest_col], keep="first")
                        elif agg_method_ts == "Start":
                            df_y = df_y.sort_values(by=date_col, ascending=True).drop_duplicates(subset=[quest_col], keep="first")
                        elif agg_method_ts == "Mean":
                            df_y_mean = df_y.groupby(["Area", quest_col])[score_col].mean().reset_index()
                            df_y = df_y_mean
                        
                        area_sums = df_y[df_y["Area"] != "Leadership"].groupby("Area")[score_col].sum()
                        row = area_sums.to_dict()
                        row["Year"] = y
                        ts_data.append(row)
                    
                    df_ts = pd.DataFrame(ts_data).set_index("Year").fillna(0)
                    xaxis_title = "Year"

                df_ts["Total"] = df_ts.sum(axis=1)
                
                fig_ts = go.Figure()
                x_values = [str(x) for x in df_ts.index.tolist()]
                total_values = df_ts["Total"].tolist()
                
                total_line_color = "black" if st.session_state.chart_theme == "Light" else "white"
                
                fig_ts.add_trace(go.Scatter(
                    x=x_values, y=total_values, 
                    mode="lines+markers", name=L["total_score"], 
                    line=dict(width=4, color=total_line_color), marker=dict(size=8)
                ))
                
                colors = ["#e74c3c", "#3498db", "#2ecc71", "#f39c12", "#9b59b6"]
                for i in range(1, 6):
                    area_name = f"Area{i}"
                    if area_name in df_ts.columns:
                        area_values = df_ts[area_name].tolist()
                        fig_ts.add_trace(go.Scatter(
                            x=x_values, y=area_values, 
                            mode="lines+markers", name=L["area_labels"][i-1],
                            line=dict(width=2, color=colors[i-1]), marker=dict(size=6)
                        ))
                
                fig_ts.update_layout(
                    template=plotly_template,
                    hovermode="x unified", 
                    yaxis=dict(title="Score", range=[0, 520]),
                    xaxis=dict(title=xaxis_title),
                    legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1),
                    height=500
                )
                st.plotly_chart(fig_ts, use_container_width=True, config=plotly_config, key=f"ts_{target_date}_{selected_facility_code}")
                st.dataframe(df_ts.style.highlight_max(axis=0), use_container_width=True)
            else:
                st.info(L["no_data"])
        
        elif selected_tab_idx == 2:
            # --- Tab 3: Comparison ---
            title_suffix = f"({st.session_state.selected_month})" if st.session_state.analysis_unit == "Month" else f"({st.session_state.selected_year})"
            st.subheader(f"{L['comparison_title']} {title_suffix}")
            
            if st.session_state.analysis_unit == "Month":
                 if st.session_state.selected_month is None:
                     df_month = pd.DataFrame()
                 else:
                     df_month = df[df[date_col] == st.session_state.selected_month].copy()
                 
                 if not df_month.empty:
                    if code_col in df_month.columns and fac_col in df_month.columns:
                        df_comp = df_month[df_month["Area"] != "Leadership"].groupby([code_col, fac_col])[score_col].sum().reset_index()
                        df_comp['Facility_Display'] = df_comp[fac_col] + " (" + df_comp[code_col].astype(str) + ")"
                    else:
                        df_comp = df_month[df_month["Area"] != "Leadership"].groupby([fac_col])[score_col].sum().sort_values(ascending=True).reset_index()
                        df_comp['Facility_Display'] = df_comp[fac_col]
                    df_comp = df_comp.sort_values(by=score_col, ascending=True)
                 else:
                     df_comp = pd.DataFrame()
            else:
                # Year mode
                df_year_all = df[df["Year"] == st.session_state.selected_year].copy()
                comp_data = []
                facilities_in_year = df_year_all[[code_col, fac_col]].drop_duplicates() if code_col in df.columns else df_year_all[[fac_col]].drop_duplicates()
                
                for _, fac_row in facilities_in_year.iterrows():
                    fac_c = fac_row[code_col] if code_col in df.columns else None
                    fac_n = fac_row[fac_col]
                    
                    if fac_c:
                        df_f = df_year_all[df_year_all[code_col] == fac_c]
                    else:
                        df_f = df_year_all[df_year_all[fac_col] == fac_n]
                    
                    method = st.session_state.agg_method
                    if method == "End":
                        df_f = df_f.sort_values(by=date_col, ascending=False).drop_duplicates(subset=[quest_col], keep="first")
                    elif method == "Start":
                        df_f = df_f.sort_values(by=date_col, ascending=True).drop_duplicates(subset=[quest_col], keep="first")
                    elif method == "Mean":
                        pass
                    
                    if method == "Mean":
                         # ã‚¨ãƒªã‚¢ã”ã¨ã«å¹³å‡ -> åˆè¨ˆ (Leadershipã‚’é™¤ã)
                         score_sum = df_f[df_f["Area"] != "Leadership"].groupby(["Area", quest_col])[score_col].mean().groupby("Area").sum().sum()
                    else:
                         score_sum = df_f[df_f["Area"] != "Leadership"][score_col].sum()
                    
                    row = {fac_col: fac_n, score_col: score_sum}
                    if code_col in df.columns:
                        row[code_col] = fac_c
                    comp_data.append(row)
                
                if comp_data:
                    df_comp = pd.DataFrame(comp_data)
                    if code_col in df_comp.columns:
                        df_comp['Facility_Display'] = df_comp[fac_col] + " (" + df_comp[code_col].astype(str) + ")"
                    else:
                        df_comp['Facility_Display'] = df_comp[fac_col]
                    df_comp = df_comp.sort_values(by=score_col, ascending=True)
                else:
                    df_comp = pd.DataFrame()

            if not df_comp.empty:
                x_values_comp = df_comp[score_col].tolist()
                y_values_comp = df_comp['Facility_Display'].tolist()
                text_values_comp = [int(x) for x in x_values_comp]
                
                fig_comp = go.Figure([go.Bar(
                    x=x_values_comp, 
                    y=y_values_comp, 
                    orientation='h',
                    marker_color="#667eea",
                    text=text_values_comp,
                    textposition='auto'
                )])
                
                if code_col in df_comp.columns:
                    selected_mask = df_comp[code_col] == selected_facility_code
                else:
                    selected_mask = df_comp[fac_col] == selected_facility_name
                
                if selected_mask.any():
                    selected_data = df_comp[selected_mask]
                    x_selected = selected_data[score_col].tolist()
                    y_selected = selected_data['Facility_Display'].tolist()
                    text_selected = [int(x) for x in x_selected]
                    
                    fig_comp.add_trace(go.Bar(
                        x=x_selected,
                        y=y_selected,
                        orientation='h',
                        marker_color="#ff6b6b",
                        text=text_selected,
                        textposition='auto',
                        name="Selected Facility"
                    ))
                
                fig_comp.update_layout(
                    template=plotly_template,
                    xaxis=dict(title="Total Score", range=[0, 520]),
                    yaxis=dict(title="Facility"),
                    height=max(400, len(df_comp) * 50),
                    title=f"{L['comparison_title']} {title_suffix}",
                    showlegend=False
                )
                
                st.plotly_chart(fig_comp, use_container_width=True, config=plotly_config, key=f"comp_{target_date}_{selected_facility_code}")
                st.dataframe(df_comp[[col for col in df_comp.columns if col != 'Facility_Display'] + ['Facility_Display']].style.highlight_max(axis=0, subset=[score_col]), use_container_width=True)
            else:
                st.info(L["no_data"])
        
        elif selected_tab_idx == 3:
            # --- Tab 4: Leadership ---
            st.subheader(L["tab_leadership"])
            
            try:
                # target_dateãŒNoneã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if target_date is None:
                    st.warning("å¹´æœˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
                elif total_score >= 376:
                    st.success(L["eligible"])
                    
                    if not leadership_data.empty:
                        try:
                            # ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚¹ã‚³ã‚¢ã®å†…è¨³ï¼ˆè³ªå•é †ã«ã‚½ãƒ¼ãƒˆã€0ç‚¹ã‚‚å«ã‚ã‚‹ï¼‰
                            leadership_items = leadership_data.groupby(quest_col)[score_col].sum().sort_index()
                            
                            # leadership_itemsãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
                            if len(leadership_items) > 0 and len(leadership_items.index) > 0:
                                # ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ãƒ¬ãƒ™ãƒ«åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
                                # æ¡ä»¶1: å„åŒºåˆ†(1-5)ã§å°‘ãªãã¨ã‚‚1ã¤ä»¥ä¸Šã®åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã‚‹
                                achieved_categories = []
                                for cat in ["1", "2", "3", "4", "5"]:
                                    # è³ªå•é …ç›®åã« "åŸºæº–X." ãŒå«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’æŠ½å‡ºï¼ˆæ­£è¦è¡¨ç¾ï¼‰
                                    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ–‡å­—åˆ—ã§ãªã„å ´åˆã®å¯¾ç­–
                                    try:
                                        idx_str = leadership_items.index.astype(str)
                                        items_in_cat = leadership_items[idx_str.str.contains(fr"åŸºæº–{cat}\.", regex=True)]
                                        if len(items_in_cat) > 0 and items_in_cat.sum() >= 1:
                                            achieved_categories.append(cat)
                                    except Exception as e:
                                        # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãã®åŒºåˆ†ã‚’ã‚¹ã‚­ãƒƒãƒ—
                                        pass
                                
                                all_categories_covered = len(achieved_categories) == 5
                                is_leadership_level = (leadership_score >= 12) and all_categories_covered
                                
                                # çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨è‰²ã®è¨­å®š
                                result_msg = L["leadership_achieved"] if is_leadership_level else L["leadership_failed"]
                                bar_color = "#28a745" if is_leadership_level else "#9b59b6"
                                
                                # target_dateãŒNoneã§ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰keyã‚’ç”Ÿæˆ
                                chart_key = f"gauge_{target_date}_{selected_facility_code}" if target_date is not None else f"gauge_none_{selected_facility_code}"
                                
                                # 1. Gauge Chart for Total Leadership Score
                                fig_gauge = go.Figure(go.Indicator(
                                    mode = "gauge+number",
                                    value = leadership_score,
                                    title = {'text': f"{L['leadership_chart_title']}<br><span style='font-size:0.8em; color:gray'>{result_msg}</span>"},
                                    gauge = {
                                        'axis': {'range': [0, 20]},
                                        'bar': {'color': bar_color},
                                        'steps': [
                                            {'range': [0, 12], 'color': "#f9f9f9"}, # 12ç‚¹æœªæº€
                                            {'range': [12, 20], 'color': "#e6e6e6"}  # 12ç‚¹ä»¥ä¸Š
                                        ],
                                        'threshold': {
                                            'line': {'color': "red", 'width': 4},
                                            'thickness': 0.75,
                                            'value': 12 # åˆæ ¼ãƒ©ã‚¤ãƒ³
                                        }
                                    },
                                    number = {
                                        'font': {'size': 40},
                                        'valueformat': '.0f',
                                        'suffix': ' / 20'
                                    }
                                ))
                                # ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚°ãƒ©ãƒ•ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å›ºå®šï¼ˆç”»é¢ã‚µã‚¤ã‚ºã®èª¿æ•´ã«ã‚ˆã‚‹ãšã‚Œã‚’é˜²ãï¼‰
                                fig_gauge.update_layout(
                                    height=350,
                                    width=600,
                                    margin=dict(l=50, r=50, t=100, b=50),
                                    template=plotly_template,
                                    autosize=False
                                )
                                # ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚°ãƒ©ãƒ•ã‚’ä¸­å¤®ã«é…ç½®
                                col_left, col_center, col_right = st.columns([1, 2, 1])
                                with col_center:
                                    st.plotly_chart(fig_gauge, use_container_width=False, config=plotly_config, key=chart_key)
                                
                                # åˆ¤å®šçµæœã®è©³ç´°è¡¨ç¤º
                                if is_leadership_level:
                                    st.success(f"### {L['congrats']}")
                                
                                # é”æˆè¦ä»¶ã®èª¬æ˜ï¼ˆå¸¸æ™‚è¡¨ç¤ºã€ã¾ãŸã¯æœªé”æˆæ™‚ã®ã¿å¼·èª¿ãªã©ï¼‰
                                with st.expander(f"â„¹ï¸ {L['leadership_criteria_desc']}", expanded=not is_leadership_level):
                                    st.info(L["leadership_criteria_full"])
                                    # expanderãŒé–‹ã‹ã‚ŒãŸã¨ãã«ã€åˆå›ã®æ“ä½œã‚’ã€Œæ¶ˆè²»ã€ã™ã‚‹
                                    # æ³¨: st.expander()ã¯keyå¼•æ•°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãŸã‚ã€expanderå†…ã§å‡¦ç†
                                    if not st.session_state.first_interaction_consumed:
                                        st.session_state.first_interaction_consumed = True
                                
                                # 2. Detailed Breakdown (Checklist style)
                                st.markdown("### Breakdown")
                                
                                # Format dataframe for display
                                try:
                                    df_display = leadership_items.reset_index()
                                    if not df_display.empty and len(df_display.columns) >= 1:
                                        df_display.columns = ["Question", "Score"]
                                        
                                        # è©³ç´°èª¬æ˜ã‚’è¿½åŠ 
                                        current_lang = "ja" if lang == "æ—¥æœ¬èª" else "en"
                                        def get_desc(q_text):
                                            # Extract number (e.g. "1.1" from "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—åŸºæº–1.1")
                                            try:
                                                match = re.search(r"([0-9]+\.[0-9]+)", str(q_text))
                                                if match:
                                                    key = match.group(1)
                                                    return LEADERSHIP_DESC.get(key, {}).get(current_lang, "")
                                            except:
                                                pass
                                            return ""
                                        
                                        df_display["Description"] = df_display["Question"].apply(get_desc)
                                        
                                        # ã‚«ãƒ©ãƒ é †åºã®èª¿æ•´
                                        df_display = df_display[["Question", "Description", "Score"]]
                                        
                                        df_display["Status"] = df_display["Score"].apply(lambda x: "âœ… Achieved" if x >= 1 else "â¬œ Not Achieved")
                                        
                                        # Display as a static table (better for long text wrapping)
                                        # ã‚¹ã‚³ã‚¢åˆ—ã¯è¡¨ç¤ºã—ãªãã¦ã‚‚Statusã§åˆ†ã‹ã‚‹ã®ã§å‰Šé™¤ã€ã¾ãŸã¯Questionã¨çµåˆã—ã¦ã‚‚è‰¯ã„ãŒã€
                                        # ã“ã“ã§ã¯è¦‹ã‚„ã™ã•å„ªå…ˆã§ Question, Description, Status ã®3åˆ—ã«ã™ã‚‹
                                        df_table = df_display[["Question", "Description", "Status"]]
                                        
                                        # Apply styles
                                        st.table(
                                            df_table.style.set_properties(subset=["Description"], **{'min-width': '400px', 'white-space': 'normal'})
                                            .apply(lambda x: ['background-color: #d4edda' if v == "âœ… Achieved" else '' for v in x], subset=["Status"])
                                        )
                                    else:
                                        st.info(L["no_leadership_data"])
                                except Exception as e:
                                    st.warning(f"ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                                    import traceback
                                    st.code(traceback.format_exc())
                            else:
                                # leadership_itemsãŒç©ºã®å ´åˆ
                                st.info(L["no_leadership_data"])
                        except Exception as e:
                            st.error(f"ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
                            import traceback
                            st.code(traceback.format_exc())
                    else:
                        st.info(L["no_leadership_data"])
                else:
                    st.warning(L["not_eligible"])
                    st.info(L["leadership_required_score"].format(score=int(total_score)))
            except Exception as e:
                st.error(f"Error in Leadership Tab: {str(e)}")
                import traceback
                st.code(traceback.format_exc())

else:
    # --- Landing Page (ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠæ™‚) ---
    st.info(L["landing_info"])
    
    st.markdown(f"""
    ### {L["landing_title"]}
    
    {L["landing_desc"]}
    
    #### {L["landing_features"]}
    * **{L["landing_security"]}**
    * **{L["landing_simple"]}**
    * **{L["landing_features_desc"]}**
    
    #### {L["landing_format"]}
    {L["landing_format_desc"]}
    * \`å‡¦æ–¹ç®‹ç™ºè¡ŒåŒ»ç™‚æ©Ÿé–¢ã‚³ãƒ¼ãƒ‰\`
    * \`æ–½è¨­å\`
    * \`ç™»éŒ²å¹´æœˆ\` (ä¾‹: 202501, 2025/01)
    * \`è³ªå•\` (ä¾‹: 2.1a ç ”ä¿®é »åº¦, 3.4b ç›´æ¥è¦³å¯Ÿéµå®ˆ...)
    * \`ã‚¹ã‚³ã‚¢\` (æ•°å€¤)
    """)
`
            }
        })
    </script>
</body>

</html>